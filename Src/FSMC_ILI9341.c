/*
 * FSMC_ILI9341.h
 *
 *  Created on: May 27, 2020
 *      Author: k-omura
 *
 * FSMC 16bit
 */

//Header files
#include <FSMC_ILI9341.h>

static uint8_t rotationNum = 3;

//***** Functions *****//
void ILI9341_sendCommand16(uint16_t _cmd) {
	*(volatile uint16_t*) LCD_ADDR_BASE = _cmd;
}

void ILI9341_sendData16(uint16_t _data) {
	*(volatile uint16_t*) LCD_ADDR_DATA = _data;
}

void ILI9341_sendCommand8(uint8_t _cmd) {
	*(volatile uint16_t*) LCD_ADDR_BASE = (uint16_t) _cmd;
}

void ILI9341_sendData8(uint8_t _data) {
	*(volatile uint16_t*) LCD_ADDR_DATA = (uint16_t) _data;
}

void ILI9341_init(void) {
	ILI9341_sendCommand8(ILI9341_RESET); // software reset command
	HAL_Delay(100);
	ILI9341_sendCommand8(ILI9341_DISPLAY_OFF); // display off
	//------------power control------------------------------
	ILI9341_sendCommand8(ILI9341_POWER1); // power control
	ILI9341_sendData8(0x26); // GVDD = 4.75v
	ILI9341_sendCommand8(ILI9341_POWER2); // power control
	ILI9341_sendData8(0x11); // AVDD=VCIx2, VGH=VCIx7, VGL=-VCIx3
	//--------------VCOM-------------------------------------
	ILI9341_sendCommand8(ILI9341_VCOM1); // vcom control
	ILI9341_sendData8(0x35); // Set the VCOMH voltage (0x35 = 4.025v)
	ILI9341_sendData8(0x3e); // Set the VCOML voltage (0x3E = -0.950v)
	ILI9341_sendCommand8(ILI9341_VCOM2); // vcom control
	ILI9341_sendData8(0xbe);

	//------------memory access control------------------------
	ILI9341_sendCommand8(ILI9341_MAC); // memory access control
	ILI9341_sendData8(0x48);

	ILI9341_sendCommand8(ILI9341_PIXEL_FORMAT); // pixel format set
	ILI9341_sendData8(0x55); // 16bit /pixel

	ILI9341_sendCommand8(ILI9341_FRC);
	ILI9341_sendData8(0);
	ILI9341_sendData8(0x1F);
	//-------------ddram ----------------------------
	ILI9341_sendCommand8(ILI9341_COLUMN_ADDR); // column set
	ILI9341_sendData8(0x00); // x0_HIGH---0
	ILI9341_sendData8(0x00); // x0_LOW----0
	ILI9341_sendData8(0x00); // x1_HIGH---240
	ILI9341_sendData8(0xEF); // x1_LOW----240
	ILI9341_sendCommand8(ILI9341_PAGE_ADDR); // page address set
	ILI9341_sendData8(0x00); // y0_HIGH---0
	ILI9341_sendData8(0x00); // y0_LOW----0
	ILI9341_sendData8(0x01); // y1_HIGH---320
	ILI9341_sendData8(0x3F); // y1_LOW----320

	ILI9341_sendCommand8(ILI9341_TEARING_OFF); // tearing effect off
	//LCD_write_cmd(ILI9341_TEARING_ON); // tearing effect on
	//LCD_write_cmd(ILI9341_DISPLAY_INVERSION); // display inversion
	ILI9341_sendCommand8(ILI9341_Entry_Mode_Set); // entry mode set
	// Deep Standby Mode: OFF
	// Set the output level of gate driver G1-G320: Normal display
	// Low voltage detection: Disable
	ILI9341_sendData8(0x07);
	//-----------------display------------------------
	ILI9341_sendCommand8(ILI9341_DFC); // display function control
	//Set the scan mode in non-display area
	//Determine source/VCOM output in a non-display area in the partial display mode
	ILI9341_sendData8(0x0a);
	//Select whether the liquid crystal type is normally white type or normally black type
	//Sets the direction of scan by the gate driver in the range determined by SCN and NL
	//Select the shift direction of outputs from the source driver
	//Sets the gate driver pin arrangement in combination with the GS bit to select the optimal scan mode for the module
	//Specify the scan cycle interval of gate driver in non-display area when PTG to select interval scan
	ILI9341_sendData8(0x82);
	// Sets the number of lines to drive the LCD at an interval of 8 lines
	ILI9341_sendData8(0x27);
	ILI9341_sendData8(0x00); // clock divisor

	ILI9341_sendCommand8(ILI9341_SLEEP_OUT); // sleep out
	HAL_Delay(100);
	ILI9341_sendCommand8(ILI9341_DISPLAY_ON); // display on
	HAL_Delay(100);
	ILI9341_sendCommand8(ILI9341_GRAM); // memory write
	HAL_Delay(5);
}

void ILI9341_setRect(uint16_t _x1, uint16_t _y1, uint16_t _x2, uint16_t _y2) {
	ILI9341_sendCommand8(ILI9341_COLUMN_ADDR);
	ILI9341_sendData8(_x1 >> 8);
	ILI9341_sendData8(_x1 & 0xFF);
	ILI9341_sendData8(_x2 >> 8);
	ILI9341_sendData8(_x2 & 0xFF);

	ILI9341_sendCommand8(ILI9341_PAGE_ADDR);
	ILI9341_sendData8(_y1 >> 8);
	ILI9341_sendData8(_y1 & 0xFF);
	ILI9341_sendData8(_y2 >> 8);
	ILI9341_sendData8(_y2 & 0xFF);
	ILI9341_sendCommand8(ILI9341_GRAM);
}

void ILI9341_drawPixel(uint16_t _x, uint16_t _y, uint16_t _color) {
	ILI9341_setRect(_x, _y, _x, _y);
	ILI9341_sendData16(_color);
}

void ILI9341_fill_all(uint16_t _color) {
	uint32_t n = ILI9341_PIXEL_COUNT;

	if (rotationNum == 1 || rotationNum == 3) {
		ILI9341_setRect(0, 0, ILI9341_WIDTH - 1, ILI9341_HEIGHT - 1);
	} else if (rotationNum == 2 || rotationNum == 4) {
		ILI9341_setRect(0, 0, ILI9341_HEIGHT - 1, ILI9341_WIDTH - 1);
	}

	while (n) {
		n--;
		ILI9341_sendData16(_color);
	}
}

void ILI9341_fill_Rect(uint16_t _x1, uint16_t _y1, uint16_t _x2, uint16_t _y2,
		uint16_t _color) {
	uint32_t n = ((_x2 + 1) - _x1) * ((_y2 + 1) - _y1);
	if (n > ILI9341_PIXEL_COUNT) {
		n = ILI9341_PIXEL_COUNT;
	}
	ILI9341_setRect(_x1, _y1, _x2, _y2);
	while (n) {
		n--;
		ILI9341_sendData16(_color);
	}
}

void ILI9341_printImage(uint16_t _x, uint16_t _y, uint16_t _width,
		uint16_t _height, uint16_t *_data) {
	uint32_t n = _width * _height;
	ILI9341_setRect(_x, _y, _x + _width - 1, _y + _height - 1);
	for (uint32_t i = 0; i < n; i++) {
		ILI9341_sendData16(_data[i]);
	}
}

void ILI9341_addString(uint16_t _x, uint16_t _y, const char _character[],
		uint16_t _color, uint8_t size) {
	uint8_t c = 0;
	while (_character[c]) {
		if (size == 0) {
			add_character5(_x + (c * 4), _y, _character[c], _color);
		} else {
			add_character8(_x + (c * 8), _y, _character[c], _color);
		}
		c++;
	}
}

void add_character8(uint16_t _x, uint16_t _y, char _character, uint16_t _color) {
	uint8_t index = 0;

	for (uint8_t y = 0; y < 8; y++) {
		uint8_t fontByte;
		fontByte = FONT8x8[_character - 0x1F][y];

		for (uint8_t x = 0; x < 8; x++) {
			if (fontByte & 0x80) {
				ILI9341_drawPixel(_x + (index % 8), _y + (index / 8), _color);
			}
			fontByte = fontByte << 1;
			index++;
		}
	}
}

void add_character5(uint16_t _x, uint16_t _y, char _character, uint16_t _color) {
	uint8_t code = 12;
	if ((0x30 <= _character) && (_character <= 0x39)) {
		code = _character - 0x30;
	} else if (_character == 0x2d) {
		code = 10;
	} else if (_character == 0x2e) {
		code = 11;
	}

	uint8_t index = 0;

	for (uint8_t array = 0; array < 2; array++) {
		uint8_t fontByte;
		fontByte = FONT5x3[code][array];

		for (uint8_t i = 0; i < 8; i++) {
			if (fontByte & 0x80) {
				ILI9341_drawPixel(_x + (index % 3), _y + (index / 3), _color);
			}
			fontByte = fontByte << 1;
			index++;
		}
	}
}

void ILI9341_string(uint16_t _x, uint16_t _y, const char _character[],
		uint16_t _color, uint16_t _background, uint8_t size) {
	uint8_t c = 0;
	while (_character[c]) {
		if (size == 0) {
			character5(_x + (c * 4), _y, _character[c], _color, _background);
		} else {
			character8(_x + (c * 8), _y, _character[c], _color, _background);
		}
		c++;
	}
}

void character8(uint16_t _x, uint16_t _y, char _character, uint16_t _color,
		uint16_t _background) {
	uint8_t index = 0;

	ILI9341_setRect(_x, _y, _x + 7, _y + 7);
	for (uint8_t y = 0; y < 8; y++) {
		uint8_t fontByte;
		fontByte = FONT8x8[_character - 0x1F][y];

		for (uint8_t x = 0; x < 8; x++) {
			if (fontByte & 0x80) {
				ILI9341_sendData16(_color);
			} else {
				ILI9341_sendData16(_background);
			}
			fontByte = fontByte << 1;
			index++;
		}
	}
}

void character5(uint16_t _x, uint16_t _y, char _character, uint16_t _color,
		uint16_t _background) {
	uint8_t code = 12;

	if ((0x30 <= _character) && (_character <= 0x39)) {
		code = _character - 0x30;
	} else if (_character == 0x2d) {
		code = 10;
	} else if (_character == 0x2e) {
		code = 11;
	}

	uint8_t index = 0;

	ILI9341_setRect(_x, _y, _x + 2, _y + 4);

	for (uint8_t array = 0; array < 2; array++) {
		uint8_t fontByte;
		fontByte = FONT5x3[code][array];

		for (uint8_t i = 0; i < 8; i++) {
			if (fontByte & 0x80) {
				ILI9341_sendData16(_color);
			} else {
				ILI9341_sendData16(_background);
			}
			fontByte = fontByte << 1;
			index++;
		}
	}
}

void ILI9341_setRotation(uint16_t _rotate) {
	switch (_rotate) {
	case 1:
		rotationNum = 1;
		ILI9341_sendCommand8(ILI9341_MEMCONTROL);
		ILI9341_sendData8(ILI9341_MADCTL_MY | ILI9341_MADCTL_BGR);
		break;
	case 2:
		rotationNum = 2;
		ILI9341_sendCommand8(ILI9341_MEMCONTROL);
		ILI9341_sendData8(ILI9341_MADCTL_MV | ILI9341_MADCTL_BGR);
		break;
	case 3:
		rotationNum = 3;
		ILI9341_sendCommand8(ILI9341_MEMCONTROL);
		ILI9341_sendData8(ILI9341_MADCTL_MX | ILI9341_MADCTL_BGR);
		break;
	case 4:
		rotationNum = 4;
		ILI9341_sendCommand8(ILI9341_MEMCONTROL);
		ILI9341_sendData8(
				ILI9341_MADCTL_MX | ILI9341_MADCTL_MY | ILI9341_MADCTL_MV
						| ILI9341_MADCTL_BGR);
		break;
	default:
		rotationNum = 1;
		ILI9341_sendCommand8(ILI9341_MEMCONTROL);
		ILI9341_sendData8(ILI9341_MADCTL_MY | ILI9341_MADCTL_BGR);
		break;
	}
}

//--------font
const unsigned char FONT8x8[][8] = {
	{ 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00 }, // columns, rows, num_bytes_per_char
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // space 0x20
	{ 0x30, 0x78, 0x78, 0x30, 0x30, 0x00, 0x30, 0x00 }, // !
	{ 0x6C, 0x6C, 0x6C, 0x00, 0x00, 0x00, 0x00, 0x00 }, // "
	{ 0x6C, 0x6C, 0xFE, 0x6C, 0xFE, 0x6C, 0x6C, 0x00 }, // #
	{ 0x18, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x18, 0x00 }, // $
	{ 0x00, 0x63, 0x66, 0x0C, 0x18, 0x33, 0x63, 0x00 }, // %
	{ 0x1C, 0x36, 0x1C, 0x3B, 0x6E, 0x66, 0x3B, 0x00 }, // &
	{ 0x30, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00 }, // '
	{ 0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00 }, // (
	{ 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00 }, // )
	{ 0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00 }, // *
	{ 0x00, 0x30, 0x30, 0xFC, 0x30, 0x30, 0x00, 0x00 }, // +
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30 }, // ,
	{ 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00 }, // -
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00 }, // .
	{ 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x40, 0x00 }, // / (forward slash)
	{ 0x3E, 0x63, 0x63, 0x6B, 0x63, 0x63, 0x3E, 0x00 }, // 0 0x30
	{ 0x18, 0x38, 0x58, 0x18, 0x18, 0x18, 0x7E, 0x00 }, // 1
	{ 0x3C, 0x66, 0x06, 0x1C, 0x30, 0x66, 0x7E, 0x00 }, // 2
	{ 0x3C, 0x66, 0x06, 0x1C, 0x06, 0x66, 0x3C, 0x00 }, // 3
	{ 0x0E, 0x1E, 0x36, 0x66, 0x7F, 0x06, 0x0F, 0x00 }, // 4
	{ 0x7E, 0x60, 0x7C, 0x06, 0x06, 0x66, 0x3C, 0x00 }, // 5
	{ 0x1C, 0x30, 0x60, 0x7C, 0x66, 0x66, 0x3C, 0x00 }, // 6
	{ 0x7E, 0x66, 0x06, 0x0C, 0x18, 0x18, 0x18, 0x00 }, // 7
	{ 0x3C, 0x66, 0x66, 0x3C, 0x66, 0x66, 0x3C, 0x00 }, // 8
	{ 0x3C, 0x66, 0x66, 0x3E, 0x06, 0x0C, 0x38, 0x00 }, // 9
	{ 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00 }, // :
	{ 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x30 }, // ;
	{ 0x0C, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0C, 0x00 }, // <
	{ 0x00, 0x00, 0x7E, 0x00, 0x00, 0x7E, 0x00, 0x00 }, // =
	{ 0x30, 0x18, 0x0C, 0x06, 0x0C, 0x18, 0x30, 0x00 }, // >
	{ 0x3C, 0x66, 0x06, 0x0C, 0x18, 0x00, 0x18, 0x00 }, // ?
	{ 0x3E, 0x63, 0x6F, 0x69, 0x6F, 0x60, 0x3E, 0x00 }, // @ 0x40
	{ 0x18, 0x3C, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x00 }, // A
	{ 0x7E, 0x33, 0x33, 0x3E, 0x33, 0x33, 0x7E, 0x00 }, // B
	{ 0x1E, 0x33, 0x60, 0x60, 0x60, 0x33, 0x1E, 0x00 }, // C
	{ 0x7C, 0x36, 0x33, 0x33, 0x33, 0x36, 0x7C, 0x00 }, // D
	{ 0x7F, 0x31, 0x34, 0x3C, 0x34, 0x31, 0x7F, 0x00 }, // E
	{ 0x7F, 0x31, 0x34, 0x3C, 0x34, 0x30, 0x78, 0x00 }, // F
	{ 0x1E, 0x33, 0x60, 0x60, 0x67, 0x33, 0x1F, 0x00 }, // G
	{ 0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00 }, // H
	{ 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00 }, // I
	{ 0x0F, 0x06, 0x06, 0x06, 0x66, 0x66, 0x3C, 0x00 }, // J
	{ 0x73, 0x33, 0x36, 0x3C, 0x36, 0x33, 0x73, 0x00 }, // K
	{ 0x78, 0x30, 0x30, 0x30, 0x31, 0x33, 0x7F, 0x00 }, // L
	{ 0x63, 0x77, 0x7F, 0x7F, 0x6B, 0x63, 0x63, 0x00 }, // M
	{ 0x63, 0x73, 0x7B, 0x6F, 0x67, 0x63, 0x63, 0x00 }, // N
	{ 0x3E, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3E, 0x00 }, // O
	{ 0x7E, 0x33, 0x33, 0x3E, 0x30, 0x30, 0x78, 0x00 }, // P 0x50
	{ 0x3C, 0x66, 0x66, 0x66, 0x6E, 0x3C, 0x0E, 0x00 }, // Q
	{ 0x7E, 0x33, 0x33, 0x3E, 0x36, 0x33, 0x73, 0x00 }, // R
	{ 0x3C, 0x66, 0x30, 0x18, 0x0C, 0x66, 0x3C, 0x00 }, // S
	{ 0x7E, 0x5A, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00 }, // T
	{ 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x00 }, // U
	{ 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00 }, // V
	{ 0x63, 0x63, 0x63, 0x6B, 0x7F, 0x77, 0x63, 0x00 }, // W
	{ 0x63, 0x63, 0x36, 0x1C, 0x1C, 0x36, 0x63, 0x00 }, // X
	{ 0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x3C, 0x00 }, // Y
	{ 0x7F, 0x63, 0x46, 0x0C, 0x19, 0x33, 0x7F, 0x00 }, // Z
	{ 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00 }, // [
	{ 0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x01, 0x00 }, // \ (back slash)
	{ 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00 }, // ]
	{ 0x08, 0x1C, 0x36, 0x63, 0x00, 0x00, 0x00, 0x00 }, // ^
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF }, // _
	{ 0x18, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00 }, // ` 0x60
	{ 0x00, 0x00, 0x3C, 0x06, 0x3E, 0x66, 0x3B, 0x00 }, // a
	{ 0x70, 0x30, 0x3E, 0x33, 0x33, 0x33, 0x6E, 0x00 }, // b
	{ 0x00, 0x00, 0x3C, 0x66, 0x60, 0x66, 0x3C, 0x00 }, // c
	{ 0x0E, 0x06, 0x3E, 0x66, 0x66, 0x66, 0x3B, 0x00 }, // d
	{ 0x00, 0x00, 0x3C, 0x66, 0x7E, 0x60, 0x3C, 0x00 }, // e
	{ 0x1C, 0x36, 0x30, 0x78, 0x30, 0x30, 0x78, 0x00 }, // f
	{ 0x00, 0x00, 0x3B, 0x66, 0x66, 0x3E, 0x06, 0x7C }, // g
	{ 0x70, 0x30, 0x36, 0x3B, 0x33, 0x33, 0x73, 0x00 }, // h
	{ 0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00 }, // i
	{ 0x06, 0x00, 0x06, 0x06, 0x06, 0x66, 0x66, 0x3C }, // j
	{ 0x70, 0x30, 0x33, 0x36, 0x3C, 0x36, 0x73, 0x00 }, // k
	{ 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00 }, // l
	{ 0x00, 0x00, 0x66, 0x7F, 0x7F, 0x6B, 0x63, 0x00 }, // m
	{ 0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x00 }, // n
	{ 0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3C, 0x00 }, // o
	{ 0x00, 0x00, 0x6E, 0x33, 0x33, 0x3E, 0x30, 0x78 }, // p
	{ 0x00, 0x00, 0x3B, 0x66, 0x66, 0x3E, 0x06, 0x0F }, // q
	{ 0x00, 0x00, 0x6E, 0x3B, 0x33, 0x30, 0x78, 0x00 }, // r
	{ 0x00, 0x00, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x00 }, // s
	{ 0x08, 0x18, 0x3E, 0x18, 0x18, 0x1A, 0x0C, 0x00 }, // t
	{ 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3B, 0x00 }, // u
	{ 0x00, 0x00, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00 }, // v
	{ 0x00, 0x00, 0x63, 0x6B, 0x7F, 0x7F, 0x36, 0x00 }, // w
	{ 0x00, 0x00, 0x63, 0x36, 0x1C, 0x36, 0x63, 0x00 }, // x
	{ 0x00, 0x00, 0x66, 0x66, 0x66, 0x3E, 0x06, 0x7C }, // y
	{ 0x00, 0x00, 0x7E, 0x4C, 0x18, 0x32, 0x7E, 0x00 }, // z
	{ 0x0E, 0x18, 0x18, 0x70, 0x18, 0x18, 0x0E, 0x00 }, // {
	{ 0x0C, 0x0C, 0x0C, 0x00, 0x0C, 0x0C, 0x0C, 0x00 }, // |
	{ 0x70, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x70, 0x00 }, // }
	{ 0x3B, 0x6E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // ~
	{ 0x1C, 0x36, 0x36, 0x1C, 0x00, 0x00, 0x00, 0x00 } // DEL
};

const unsigned char FONT5x3[][2] = {
	{ 0b11110110, 0b11011110 }, // 0
	{ 0b11001001, 0b00101110 }, // 1
	{ 0b11100111, 0b11001110 }, // 2
	{ 0b11100111, 0b10011110 }, // 3
	{ 0b10110111, 0b10010010 }, // 4
	{ 0b11110011, 0b10011110 }, // 5
	{ 0b10010011, 0b11011110 }, // 6
	{ 0b11100100, 0b10010010 }, // 7
	{ 0b11110111, 0b11011110 }, // 8
	{ 0b11110111, 0b10010010 }, // 9
	{ 0b00000011, 0b10000000 }, // -
	{ 0b00000000, 0b00000100 }, // .
	{ 0b00000000, 0b00000000 }, // space
};
